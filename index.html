<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸­æ•¸å­¸é€²åº¦è¿½è¹¤ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        .tab-container {
            display: flex;
            background: #f5f5f5;
            border-bottom: 3px solid #ddd;
        }
        
        .tab-button {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab-button.active {
            background: white;
            color: #2196F3;
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            right: 0;
            height: 3px;
            background: #2196F3;
        }
        
        .tab-content {
            display: none;
            padding: 30px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 1.1em;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }
        
        .form-group select:focus, .form-group input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 10px rgba(33, 150, 243, 0.2);
        }
        
        .chapter-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .chapter-card {
            border: 2px solid #ddd;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9f9f9;
        }
        
        .chapter-card:hover {
            border-color: #2196F3;
            background: #e3f2fd;
            transform: translateY(-2px);
        }
        
        .chapter-card.selected {
            border-color: #4CAF50;
            background: #e8f5e8;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }
        
        .chapter-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        
        .chapter-card p {
            color: #666;
            font-size: 0.9em;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        }
        
        .submit-btn:hover {
            background: linear-gradient(45deg, #45a049, #4CAF50);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }
        
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        .chart-container {
            background: #f9f9f9;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            height: 450px;
        }
        
        .chart-title {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding: 8px;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border-radius: 8px;
        }
        
        .chart-canvas {
            height: 350px;
            width: 100%;
        }
        
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }
        
        .date-display {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .chapter-selection {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .tab-button {
                padding: 15px 10px;
                font-size: 1em;
            }
            
            .chart-container {
                height: 400px;
            }
            
            .chart-canvas {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š åœ‹ä¸­æ•¸å­¸é€²åº¦è¿½è¹¤ç³»çµ±</h1>
            <p>è¿½è¹¤ä½ çš„å­¸ç¿’é€²åº¦ï¼Œèˆ‡åŒå­¸ä¸€èµ·é€²æ­¥ï¼</p>
        </div>
        
        <div class="tab-container">
            <button class="tab-button active" onclick="showTab(0)">ğŸ“ å­¸ç”Ÿå¡«å¯«é€²åº¦</button>
            <button class="tab-button" onclick="showTab(1)">ğŸ“Š é€²åº¦çµ±è¨ˆåœ–è¡¨</button>
        </div>
        
        <!-- å­¸ç”Ÿå¡«å¯«é é¢ -->
        <div class="tab-content active" id="student-form">
            <div class="success-message" id="success-message">âœ… é€²åº¦å·²æˆåŠŸæäº¤ï¼</div>
            
            <div class="date-display" id="current-date"></div>
            
            <form onsubmit="submitProgress(event)" id="progress-form">
                <div class="form-group">
                    <label for="class-select">ğŸ« é¸æ“‡ç­ç´š</label>
                    <select id="class-select" required>
                        <option value="">è«‹é¸æ“‡ç­ç´š</option>
                        <option value="807">å…«å¹´ä¸ƒç­ (807)</option>
                        <option value="808">å…«å¹´å…«ç­ (808)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="student-number">ğŸ‘¨â€ğŸ“ é¸æ“‡åº§è™Ÿ</label>
                    <select id="student-number" required disabled>
                        <option value="">è«‹å…ˆé¸æ“‡ç­ç´š</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“– é¸æ“‡ç« ç¯€</label>
                    <div class="chapter-selection">
                        <div class="chapter-card" data-chapter="4-2">
                            <h3>ç¬¬4-2ç« </h3>
                            <p>é ç¢¼ç¯„åœ: p.133-147</p>
                        </div>
                        <div class="chapter-card" data-chapter="4-3">
                            <h3>ç¬¬4-3ç« </h3>
                            <p>é ç¢¼ç¯„åœ: p.149-168</p>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="page-group" style="display: none;">
                    <label for="page-select">ğŸ“„ å®Œæˆåˆ°ç¬¬å¹¾é </label>
                    <select id="page-select" required>
                        <option value="">è«‹é¸æ“‡é ç¢¼</option>
                    </select>
                </div>
                
                <button type="submit" class="submit-btn" id="submit-btn" disabled>æäº¤é€²åº¦ ğŸš€</button>
            </form>
        </div>
        
        <!-- çµ±è¨ˆåœ–è¡¨é é¢ -->
        <div class="tab-content" id="dashboard">
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">807ç­ 4-2ç«  é€²åº¦åœ–</div>
                    <canvas id="chart-807-4-2" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">807ç­ 4-3ç«  é€²åº¦åœ–</div>
                    <canvas id="chart-807-4-3" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">808ç­ 4-2ç«  é€²åº¦åœ–</div>
                    <canvas id="chart-808-4-2" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-container">
                    <div class="chart-title">808ç­ 4-3ç«  é€²åº¦åœ–</div>
                    <canvas id="chart-808-4-3" class="chart-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ç³»çµ±é…ç½®
        const CONFIG = {
            classes: {
                '807': [1,2,4,5,6,7,8,9,10,11,12,13,14,15,17,18,19,20,21,22,23,24,26], // æ’é™¤3,16,25
                '808': Array.from({length: 25}, (_, i) => i + 1).filter(n => n !== 22) // æ’é™¤22
            },
            chapters: {
                '4-2': { min: 133, max: 147 },
                '4-3': { min: 149, max: 168 }
            }
        };

        // è³‡æ–™å„²å­˜
        let progressData = [];
        
        
        // è®€å– Google Sheet è³‡æ–™
        async function loadProgressDataFromSheet() {
            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbzeJvf_tEB2ZLDo6A_I9KnA5tedWHSsc3CeHRazXt23VmykDuLFYR3eFbitDC_Ve7sN/exec");
                const rows = await res.json();
                const [headers, ...dataRows] = rows;
                progressData = dataRows.map(row => {
                    const entry = {};
                    headers.forEach((key, i) => {
                        entry[key] = row[i];
                    });
                    return entry;
                });
                console.log("å¾ Google Sheet è¼‰å…¥è³‡æ–™æˆåŠŸ", progressData);
                updateCharts();
            } catch (err) {
                console.error("è¼‰å…¥è³‡æ–™å¤±æ•—", err);
            }
        }

        // ä¸Šå‚³å–®ç­†è³‡æ–™åˆ° Google Sheet
        async function submitProgress(e) {
            e.preventDefault();

            const selectedChapter = document.querySelector('.chapter-card.selected');
            if (!selectedChapter) return;

            const formData = {
                class: document.getElementById('class-select').value,
                seat: document.getElementById('student-number').value,
                chapter: selectedChapter.dataset.chapter,
                page: parseInt(document.getElementById('page-select').value),
                date: new Date().toISOString().split('T')[0]
            };

            console.log('æäº¤é€²åº¦:', formData);

            try {
                const res = await fetch("https://script.google.com/macros/s/AKfycbzeJvf_tEB2ZLDo6A_I9KnA5tedWHSsc3CeHRazXt23VmykDuLFYR3eFbitDC_Ve7sN/exec", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(formData)
                });
                if (res.ok) {
                    document.getElementById('success-message').style.display = 'block';
                    setTimeout(() => {
                        document.getElementById('success-message').style.display = 'none';
                    }, 3000);
                    document.getElementById('progress-form').reset();
                    document.querySelectorAll('.chapter-card').forEach(card => card.classList.remove('selected'));
                    document.getElementById('page-group').style.display = 'none';
                    document.getElementById('student-number').disabled = true;
                    document.getElementById('submit-btn').disabled = true;
                    loadProgressDataFromSheet();
                } else {
                    alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                }
            } catch (err) {
                console.error('æäº¤éŒ¯èª¤:', err);
                alert('ç„¡æ³•é€£æ¥è³‡æ–™åº«');
            }
        }

        // è¼‰å…¥æ™‚å¾ Google Sheet è¼‰å…¥è³‡æ–™
        window.addEventListener('load', function () {
            showCurrentDate();
            setupEventListeners();
            loadProgressDataFromSheet();
        });

        // å·²æ•´åˆ Google Sheetï¼Œåœç”¨ initSampleData
        function initSampleData() {
            const sampleData = [
                {class: '807', studentNumber: '1', chapter: '4-2', page: 140, date: '2025-06-04', timestamp: '2025-06-04T10:00:00Z'},
                {class: '807', studentNumber: '2', chapter: '4-2', page: 135, date: '2025-06-04', timestamp: '2025-06-04T10:01:00Z'},
                {class: '807', studentNumber: '4', chapter: '4-2', page: 142, date: '2025-06-04', timestamp: '2025-06-04T10:02:00Z'},
                {class: '807', studentNumber: '1', chapter: '4-3', page: 155, date: '2025-06-04', timestamp: '2025-06-04T10:03:00Z'},
                {class: '807', studentNumber: '2', chapter: '4-3', page: 160, date: '2025-06-04', timestamp: '2025-06-04T10:04:00Z'},
                {class: '808', studentNumber: '1', chapter: '4-2', page: 145, date: '2025-06-04', timestamp: '2025-06-04T10:05:00Z'},
                {class: '808', studentNumber: '2', chapter: '4-2', page: 138, date: '2025-06-04', timestamp: '2025-06-04T10:06:00Z'},
                {class: '808', studentNumber: '1', chapter: '4-3', page: 162, date: '2025-06-04', timestamp: '2025-06-04T10:07:00Z'},
                {class: '808', studentNumber: '3', chapter: '4-3', page: 158, date: '2025-06-04', timestamp: '2025-06-04T10:08:00Z'},
            ];
            progressData = sampleData;
        }

        // DOMè¼‰å…¥å®Œæˆå¾ŒåŸ·è¡Œ
        window.addEventListener('load', function() {
            console.log('é é¢è¼‰å…¥å®Œæˆ');
            initSampleData();
            showCurrentDate();
            setupEventListeners();
            // å»¶é²æ›´æ–°åœ–è¡¨ç¢ºä¿Chart.jsè¼‰å…¥å®Œæˆ
            setTimeout(updateCharts, 500);
        });

        // é¡¯ç¤ºç•¶å‰æ—¥æœŸ
        function showCurrentDate() {
            const today = new Date();
            const dateStr = today.toLocaleDateString('zh-TW', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                weekday: 'long'
            });
            const dateElement = document.getElementById('current-date');
            if (dateElement) {
                dateElement.textContent = `ğŸ“… ä»Šå¤©æ˜¯ ${dateStr}`;
            }
        }

        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            // ç­ç´šé¸æ“‡
            const classSelect = document.getElementById('class-select');
            if (classSelect) {
                classSelect.addEventListener('change', function() {
                    console.log('ç­ç´šé¸æ“‡è®Šæ›´:', this.value);
                    updateStudentNumbers();
                });
            }
            
            // ç« ç¯€é¸æ“‡
            document.querySelectorAll('.chapter-card').forEach(card => {
                card.addEventListener('click', function() {
                    console.log('ç« ç¯€é¸æ“‡:', this.dataset.chapter);
                    selectChapter(this);
                });
            });
            
            // è¡¨å–®æäº¤
            const form = document.getElementById('progress-form');
            if (form) {
                form.addEventListener('submit', submitProgress);
            }
        }

        // æ›´æ–°åº§è™Ÿé¸é …
        function updateStudentNumbers() {
            const classSelect = document.getElementById('class-select');
            const studentSelect = document.getElementById('student-number');
            
            if (!classSelect || !studentSelect) return;
            
            const selectedClass = classSelect.value;
            console.log('æ›´æ–°åº§è™Ÿï¼Œé¸æ“‡çš„ç­ç´š:', selectedClass);
            
            // æ¸…ç©ºåº§è™Ÿé¸é …
            studentSelect.innerHTML = '<option value="">è«‹é¸æ“‡åº§è™Ÿ</option>';
            
            if (selectedClass && CONFIG.classes[selectedClass]) {
                const studentNumbers = CONFIG.classes[selectedClass];
                console.log('åº§è™Ÿåˆ—è¡¨:', studentNumbers);
                
                studentNumbers.forEach(num => {
                    const option = document.createElement('option');
                    option.value = num.toString();
                    option.textContent = `${num}è™Ÿ`;
                    studentSelect.appendChild(option);
                });
                studentSelect.disabled = false;
            } else {
                studentSelect.disabled = true;
            }
            
            checkFormCompletion();
        }

        // é¸æ“‡ç« ç¯€
        function selectChapter(clickedCard) {
            // æ¸…é™¤ä¹‹å‰çš„é¸æ“‡
            document.querySelectorAll('.chapter-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // é¸æ“‡ç•¶å‰ç« ç¯€
            clickedCard.classList.add('selected');
            const chapter = clickedCard.dataset.chapter;
            console.log('é¸æ“‡ç« ç¯€:', chapter);
            
            // æ›´æ–°é ç¢¼é¸é …
            updatePageOptions(chapter);
            
            // é¡¯ç¤ºé ç¢¼é¸æ“‡
            const pageGroup = document.getElementById('page-group');
            if (pageGroup) {
                pageGroup.style.display = 'block';
            }
            
            checkFormCompletion();
        }

        // æ›´æ–°é ç¢¼é¸é …
        function updatePageOptions(chapter) {
            const pageSelect = document.getElementById('page-select');
            if (!pageSelect) return;
            
            const chapterConfig = CONFIG.chapters[chapter];
            console.log('æ›´æ–°é ç¢¼é¸é …ï¼Œç« ç¯€:', chapter, 'é…ç½®:', chapterConfig);
            
            pageSelect.innerHTML = '<option value="">è«‹é¸æ“‡é ç¢¼</option>';
            
            if (chapterConfig) {
                for (let page = chapterConfig.min; page <= chapterConfig.max; page++) {
                    const option = document.createElement('option');
                    option.value = page.toString();
                    option.textContent = `ç¬¬${page}é `;
                    pageSelect.appendChild(option);
                }
                
                // æ·»åŠ changeäº‹ä»¶ç›£è½å™¨
                pageSelect.removeEventListener('change', checkFormCompletion);
                pageSelect.addEventListener('change', checkFormCompletion);
            }
        }

        // æª¢æŸ¥è¡¨å–®å®Œæˆåº¦
        function checkFormCompletion() {
            const classValue = document.getElementById('class-select')?.value;
            const studentValue = document.getElementById('student-number')?.value;
            const selectedChapter = document.querySelector('.chapter-card.selected');
            const pageValue = document.getElementById('page-select')?.value;
            
            const isComplete = classValue && studentValue && selectedChapter && pageValue;
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = !isComplete;
            }
            
            console.log('è¡¨å–®æª¢æŸ¥:', {classValue, studentValue, selectedChapter: !!selectedChapter, pageValue, isComplete});
        }

        // æäº¤é€²åº¦
        function submitProgress(e) {
            e.preventDefault();
            
            const selectedChapter = document.querySelector('.chapter-card.selected');
            if (!selectedChapter) return;
            
            const formData = {
                class: document.getElementById('class-select').value,
                studentNumber: document.getElementById('student-number').value,
                chapter: selectedChapter.dataset.chapter,
                page: parseInt(document.getElementById('page-select').value),
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString()
            };
            
            console.log('æäº¤é€²åº¦:', formData);
            
            // å„²å­˜è³‡æ–™
            progressData.push(formData);
            
            // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
            const successMessage = document.getElementById('success-message');
            if (successMessage) {
                successMessage.style.display = 'block';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 3000);
            }
            
            // é‡ç½®è¡¨å–®
            document.getElementById('progress-form').reset();
            document.querySelectorAll('.chapter-card').forEach(card => {
                card.classList.remove('selected');
            });
            const pageGroup = document.getElementById('page-group');
            if (pageGroup) {
                pageGroup.style.display = 'none';
            }
            const studentSelect = document.getElementById('student-number');
            if (studentSelect) {
                studentSelect.disabled = true;
            }
            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = true;
            }
            
            // æ›´æ–°åœ–è¡¨
            updateCharts();
        }

        // åˆ‡æ›åˆ†é 
        function showTab(index) {
            console.log('åˆ‡æ›åˆ†é :', index);
            
            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab-button').forEach((btn, i) => {
                btn.classList.toggle('active', i === index);
            });
            
            // æ›´æ–°å…§å®¹é¡¯ç¤º
            document.querySelectorAll('.tab-content').forEach((content, i) => {
                content.classList.toggle('active', i === index);
            });
            
            // å¦‚æœåˆ‡æ›åˆ°åœ–è¡¨é é¢ï¼Œæ›´æ–°åœ–è¡¨
            if (index === 1) {
                setTimeout(updateCharts, 200);
            }
        }

        // æ›´æ–°æ‰€æœ‰åœ–è¡¨
        function updateCharts() {
            console.log('é–‹å§‹æ›´æ–°åœ–è¡¨');
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js å°šæœªè¼‰å…¥');
                setTimeout(updateCharts, 500);
                return;
            }
            
            const combinations = [
                { class: '807', chapter: '4-2' },
                { class: '807', chapter: '4-3' },
                { class: '808', chapter: '4-2' },
                { class: '808', chapter: '4-3' }
            ];
            
            combinations.forEach(combo => {
                createChart(combo.class, combo.chapter);
            });
        }

        // å‰µå»ºåœ–è¡¨
        function createChart(className, chapter) {
            const canvasId = `chart-${className}-${chapter}`;
            const canvas = document.getElementById(canvasId);
            
            if (!canvas) {
                console.error('æ‰¾ä¸åˆ° canvas:', canvasId);
                return;
            }
            
            console.log(`å‰µå»ºåœ–è¡¨: ${className}-${chapter}`);
            
            const ctx = canvas.getContext('2d');
            
            // ç²å–è©²ç­ç´šè©²ç« ç¯€çš„æœ€æ–°è³‡æ–™
            const studentNumbers = CONFIG.classes[className];
            const latestData = getLatestProgressData(className, chapter);
            const chapterRange = CONFIG.chapters[chapter];
            
            // æº–å‚™åœ–è¡¨è³‡æ–™
            const labels = studentNumbers.map(num => `${num}è™Ÿ`);
            const data = studentNumbers.map(num => {
                const studentData = latestData.find(d => d.studentNumber == num);
                // å¦‚æœæ²’æœ‰è³‡æ–™ï¼Œè¿”å›ç« ç¯€èµ·å§‹é -1ï¼Œè¡¨ç¤ºå°šæœªé–‹å§‹
                return studentData ? studentData.page : chapterRange.min - 1;
            });
            
            const colors = data.map(value => {
                if (value < chapterRange.min) return '#e0e0e0'; // å°šæœªé–‹å§‹
                const progress = (value - chapterRange.min) / (chapterRange.max - chapterRange.min);
                if (progress < 0.3) return '#ff6b6b'; // ç´…è‰²ï¼šé€²åº¦è¼ƒæ…¢
                if (progress < 0.7) return '#ffd93d'; // é»ƒè‰²ï¼šé€²åº¦ä¸­ç­‰
                return '#6bcf7f'; // ç¶ è‰²ï¼šé€²åº¦è‰¯å¥½
            });
            
            // æ¸…é™¤èˆŠåœ–è¡¨
            if (window.charts && window.charts[canvasId]) {
                window.charts[canvasId].destroy();
            }
            
            // å‰µå»ºæ–°åœ–è¡¨
            if (!window.charts) window.charts = {};
            
            try {
                window.charts[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'å®Œæˆé æ•¸',
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(color => color === '#e0e0e0' ? '#bdbdbd' : color),
                            borderWidth: 2,
                            borderRadius: 6,
                            borderSkipped: false,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        if (value < chapterRange.min) {
                                            return 'å°šæœªé–‹å§‹';
                                        }
                                        return `å®Œæˆåˆ°ç¬¬ ${value} é `;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                min: chapterRange.min - 2,
                                max: chapterRange.max + 2,
                                title: {
                                    display: true,
                                    text: 'é ç¢¼',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                ticks: {
                                    stepSize: 2,
                                    callback: function(value) {
                                        // åªé¡¯ç¤ºç« ç¯€ç¯„åœå…§çš„é ç¢¼
                                        if (value >= chapterRange.min && value <= chapterRange.max) {
                                            return value;
                                        }
                                        return '';
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'åº§è™Ÿ',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    display: false
                                }
                            }
                        },
                        animation: {
                            duration: 800,
                            easing: 'easeInOutQuart'
                        }
                    }
                });
                console.log(`åœ–è¡¨ ${canvasId} å‰µå»ºæˆåŠŸ`);
            } catch (error) {
                console.error(`å‰µå»ºåœ–è¡¨ ${canvasId} å¤±æ•—:`, error);
            }
        }

        // ç²å–æœ€æ–°é€²åº¦è³‡æ–™
        function getLatestProgressData(className, chapter) {
            const filtered = progressData.filter(d => 
                d.class === className && d.chapter === chapter
            );
            
            // æŒ‰å­¸ç”Ÿåˆ†çµ„ï¼Œå–æœ€æ–°è¨˜éŒ„
            const latestByStudent = {};
            filtered.forEach(record => {
                const key = record.studentNumber;
                if (!latestByStudent[key] || new Date(record.timestamp) > new Date(latestByStudent[key].timestamp)) {
                    latestByStudent[key] = record;
                }
            });
            
            return Object.values(latestByStudent);
        }
    </script>

<script>
async function submitProgress(event) {
  event.preventDefault(); {
  const classValue = document.getElementById("class").value;
  const seatValue = document.getElementById("seat").value;
  const chapterValue = document.querySelector('input[name="chapter"]:checked')?.value || "";
  const pageValue = document.getElementById("page").value;
  const dateValue = new Date().toISOString().split('T')[0];

  const payload = {
    class: classValue,
    seat: seatValue,
    chapter: chapterValue,
    page: pageValue,
    date: dateValue,
  };

  try {
    const res = await fetch("https://script.google.com/macros/s/AKfycbzkqwaixSjoh67drM3f-SO4f2_GOypao0LfrhPDIrIIhAhVAgJkBDEZMy45V5tFivkb/exec", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(payload)
    });

    const msg = await res.text();
    console.log("å¯«å…¥çµæœï¼š", msg);
    alert("âœ… æˆåŠŸæäº¤ï¼");
    await loadData();
  } catch (err) {
    console.error("âŒ å¯«å…¥å¤±æ•—ï¼š", err);
    alert("æäº¤å¤±æ•—ï¼");
  }
}
</script>

</body>
</html>